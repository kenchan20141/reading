<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>經典散文・沉浸式閱讀器</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK (Compatibility version for easier integration) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        /* --- 1. 核心與主題設定 (Core & Theming) --- */
        :root {
            --bg-color-light: #F4F4F3;
            --text-primary-light: #2c3e50;
            --text-secondary-light: #7f8c8d;
            --content-bg-light: #FFFFFF;
            --border-color-light: #EAEAEA;
            --accent-color: #2980b9;
            --accent-color-hover: #3498db;
            
            --bg-color-dark: #1F1F1F;
            --text-primary-dark: #D1CFCB;
            --text-secondary-dark: #888888;
            --content-bg-dark: #2A2A2A;
            --border-color-dark: #444444;

            --overlay-bg: rgba(44, 62, 80, 0.7);

            --font-sans: 'Noto Sans TC', sans-serif;
            --font-serif: 'Noto Serif TC', serif;
            --max-width: 1100px;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-sans);
            transition: background-color 0.4s, color 0.4s;
            line-height: 1.8;
            font-size: 16px;
        }
        
        body.light-mode {
            background-color: var(--bg-color-light);
            color: var(--text-primary-light);
        }

        body.dark-mode {
            background-color: var(--bg-color-dark);
            color: var(--text-primary-dark);
        }

        /* --- 2. 全域版面與容器 (Global Layout & Containers) --- */
        .page-container {
            display: grid;
            place-items: center;
            min-height: 100vh;
            padding: 2rem 1rem;
        }
        
        .hidden { display: none !important; }

        /* --- 3. UI 控制項 (UI Controls & Icons) --- */
        .icon-btn {
            background: none; border: none; cursor: pointer;
            padding: 0.5rem; border-radius: 50%;
            display: inline-flex; justify-content: center; align-items: center;
            transition: background-color 0.2s, transform 0.2s;
        }
        .icon-btn svg {
            width: 24px; height: 24px; stroke-width: 1.5;
            transition: stroke 0.2s, fill 0.2s;
        }
        .light-mode .icon-btn svg { stroke: var(--text-primary-light); }
        .dark-mode .icon-btn svg { stroke: var(--text-primary-dark); }
        .light-mode .icon-btn:hover { background-color: rgba(0,0,0,0.05); }
        .dark-mode .icon-btn:hover { background-color: var(--content-bg-dark); }
        .icon-btn:hover { transform: scale(1.1); }
        .fullscreen-btn .icon-exit-fullscreen { display: none; }
        
        /* --- NEW: Password Overlay & Modal --- */
        .password-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: var(--bg-color-light); /* Start with light mode bg */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .dark-mode .password-overlay {
            background-color: var(--bg-color-dark);
        }
        .password-modal {
            background-color: var(--content-bg-light);
            color: var(--text-primary-light);
            padding: 2.5rem;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            text-align: center;
            width: 90%;
            max-width: 400px;
            transition: background-color 0.4s, color 0.4s;
        }
        .dark-mode .password-modal {
            background-color: var(--content-bg-dark);
            color: var(--text-primary-dark);
        }
        .password-modal h2 {
            font-family: var(--font-serif);
            margin-bottom: 0.75rem;
        }
        .password-modal .subtitle {
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }
        .light-mode .password-modal .subtitle { color: var(--text-secondary-light); }
        .dark-mode .password-modal .subtitle { color: var(--text-secondary-dark); }

        #password-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 5px;
            border: 1px solid;
            font-size: 1rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        .light-mode #password-input {
            border-color: var(--border-color-light);
            background-color: var(--bg-color-light);
            color: var(--text-primary-light);
        }
        .dark-mode #password-input {
            border-color: var(--border-color-dark);
            background-color: var(--bg-color-dark);
            color: var(--text-primary-dark);
        }
        #password-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(41, 128, 185, 0.3);
        }
        .password-modal button {
            width: 100%;
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-family: var(--font-sans);
            font-size: 1.1rem;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        .password-modal button:hover {
            background-color: var(--accent-color-hover);
        }
        .password-modal button:disabled {
            background-color: #cccccc; cursor: not-allowed;
        }
        .password-error {
            color: #e74c3c;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        /* --- 4. 主要區塊：設定、閱讀器 (Main Sections: Settings, Reader) --- */
        .main-content-wrapper {
            width: 100%; max-width: var(--max-width);
            transition: all 0.4s ease-in-out;
        }
        .settings-card, .reader-card {
            border: 1px solid; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            padding: 2rem 3rem;
            transition: background-color 0.4s, border-color 0.4s;
        }
        .light-mode .settings-card, .light-mode .reader-card {
            background-color: var(--content-bg-light); border-color: var(--border-color-light);
        }
        .dark-mode .settings-card, .dark-mode .reader-card {
            background-color: var(--content-bg-dark); border-color: var(--border-color-dark);
        }
        
        /* --- 5. 設定區塊樣式 (Settings Section Styles) --- */
        .settings-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            position: relative; margin-bottom: 2.5rem;
        }
        .settings-header .title-group { text-align: center; width: 100%; }
        .settings-header .title-group h1 {
            font-family: var(--font-serif); font-weight: 600;
            font-size: 2rem; margin-bottom: 0.5rem;
        }
        .settings-header .title-group p { font-size: 1rem; }
        .light-mode .settings-header .title-group p { color: var(--text-secondary-light); }
        .dark-mode .settings-header .title-group p { color: var(--text-secondary-dark); }
        .settings-header .header-controls { position: absolute; top: -12px; right: -16px; }
        
        .form-group { margin-bottom: 2rem; }
        .form-group label { display: block; margin-bottom: 0.75rem; font-weight: 500; font-size: 1.1rem; }
        
        .rating-dots { display: flex; gap: 12px; cursor: pointer; }
        .rating-dot { width: 28px; height: 28px; border-radius: 50%; border: 2px solid; transition: all 0.2s ease-in-out; }
        .light-mode .rating-dot { border-color: #ccc; }
        .dark-mode .rating-dot { border-color: #555; }
        .rating-dots:hover .rating-dot, .rating-dots .rating-dot.selected { border-color: var(--accent-color); background-color: var(--accent-color); transform: scale(1.1); }
        .rating-dots:hover .rating-dot:hover ~ .rating-dot { background-color: transparent; border-color: #ccc; }
        .dark-mode .rating-dots:hover .rating-dot:hover ~ .rating-dot { border-color: #555; }
        
        .required-indicator { color: #e74c3c; margin-left: 4px; }
        #error-message { color: #e74c3c; margin-top: 0.5rem; display: none; font-size: 0.9rem; }
        
        textarea {
            width: 100%; min-height: 100px; padding: 0.75rem 1rem; border-radius: 5px;
            font-family: inherit; font-size: 1rem; line-height: 1.6;
            transition: background-color 0.4s, color 0.4s, border-color 0.4s;
        }
        .light-mode textarea { background-color: var(--bg-color-light); border: 1px solid var(--border-color-light); color: var(--text-primary-light); }
        .dark-mode textarea { background-color: var(--bg-color-dark); border: 1px solid var(--border-color-dark); color: var(--text-primary-dark); }
        textarea:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 2px rgba(41, 128, 185, 0.3); }
        
        .submit-btn {
            background-color: var(--accent-color); color: white; border: none; padding: 0.75rem 1.75rem; border-radius: 5px; cursor: pointer;
            font-family: inherit; font-size: 1.1rem; font-weight: 500; transition: background-color 0.3s, transform 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 10px; width: 100%; margin-top: 1rem;
        }
        .submit-btn:hover { background-color: var(--accent-color-hover); }
        .submit-btn:active { transform: scale(0.98); }
        .submit-btn:disabled { background-color: #cccccc; cursor: not-allowed; }
        .loader { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- 6. 閱讀器頂部控制列 (Reader Header Controls) --- */
        .reader-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding: 0 0.5rem; }
        .reader-controls .left-controls, .reader-controls .right-controls { display: flex; align-items: center; gap: 0.5rem; }

        /* --- 7. 書本閱讀器 (Book Reader) --- REVISED --- */
        .book-container {
            width: 100%;
            height: 75vh; /* 增加高度以容納更多內容 */
            min-height: 550px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* 隱藏容器外的頁面 */
            user-select: none;
            cursor: grab;
        }
        .book-container:active { cursor: grabbing; }

        .book {
            width: 100%;
            height: 100%;
            display: flex; /* 讓頁面並排排列 */
            /* JS 會控制 transform */
        }

        .page {
            width: 100%;
            height: 100%;
            flex-shrink: 0; /* 防止頁面被壓縮 */
            position: relative; /* 為了頁碼定位 */
            border: 1px solid;
        }
        
        .page-content {
            width: 100%;
            height: 100%;
            padding: 2rem 2.5rem 3.5rem 2.5rem; /* 增加底部 padding */
            overflow: hidden; /* 確保內容不溢出，取代滾動條 */
            font-family: var(--font-serif);
            font-size: 1.1rem;
            letter-spacing: 0.05em;
            line-height: 2;
        }

        .light-mode .page { background: var(--content-bg-light); border-color: var(--border-color-light); }
        .dark-mode .page { background: var(--content-bg-dark); border-color: var(--border-color-dark); }
        .light-mode .page-content { color: var(--text-primary-light); }
        .dark-mode .page-content { color: var(--text-primary-dark); }
        
        .page-content h2.article-title { font-size: 2rem; font-weight: 600; margin-bottom: 0.75rem; text-align: center; }
        .page-content p.article-author { font-family: var(--font-sans); font-size: 1rem; margin-bottom: 1.5rem; text-align: center; color: var(--accent-color); }
        .page-content .article-outline { font-family: var(--font-sans); font-style: italic; font-size: 1rem; text-align: center; margin: 1rem 0 2rem 0; padding-bottom: 2rem; border-bottom: 1px solid; }
        .light-mode .page-content .article-outline { color: var(--text-secondary-light); border-color: var(--border-color-light); }
        .dark-mode .page-content .article-outline { color: var(--text-secondary-dark); border-color: var(--border-color-dark); }
        
        .article-appreciation { margin-top: 3rem; padding-top: 2rem; border-top: 1px solid; }
        .light-mode .article-appreciation { border-color: var(--border-color-light); }
        .dark-mode .article-appreciation { border-color: var(--border-color-dark); }
        .article-appreciation h3 { font-family: var(--font-sans); font-weight: 500; font-size: 1.25rem; margin-bottom: 1rem; }
        .article-appreciation p { font-family: var(--font-sans); font-size: 1rem; line-height: 1.8; }
        
        .page-content .page-number {
            position: absolute;
            bottom: 1.5rem; /* 調整位置以對應 padding */
            left: 50%;
            transform: translateX(-50%);
            font-family: var(--font-sans);
            font-size: 0.9rem;
        }
        .light-mode .page-content .page-number { color: var(--text-secondary-light); }
        .dark-mode .page-content .page-number { color: var(--text-secondary-dark); }
        
        #sizer {
            position: absolute;
            visibility: hidden;
            z-index: -100;
            overflow: hidden;
            font-family: var(--font-serif);
            font-size: 1.1rem;
            letter-spacing: 0.05em;
            line-height: 2;
            padding: 2rem 2.5rem 3.5rem 2.5rem;
        }

        /* --- 8. 全螢幕模式 (Fullscreen Mode) --- REVISED --- */
        body.fullscreen-mode { overflow: hidden; }
        body.light-mode.fullscreen-mode { background-color: var(--content-bg-light); }
        body.dark-mode.fullscreen-mode { background-color: var(--content-bg-dark); }
        body.fullscreen-mode .page-container { padding: 0; }
        body.fullscreen-mode .main-content-wrapper { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; max-width: none; z-index: 1000; }
        body.fullscreen-mode .reader-card {
            border-radius: 0; border: none; box-shadow: none; height: 100%;
            display: flex; flex-direction: column; padding: 1.5rem;
        }
        body.fullscreen-mode .book-container {
            flex-grow: 1; min-height: auto; height: auto; /* 改為自動高度 */
        }
        body.fullscreen-mode .fullscreen-btn .icon-enter-fullscreen { display: none; }
        body.fullscreen-mode .fullscreen-btn .icon-exit-fullscreen { display: block; }
        
        /* --- 9. 歷史紀錄彈窗 (History Modal) --- */
        .history-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--overlay-bg);
            display: flex; justify-content: center; align-items: center; z-index: 2000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0s 0.3s;
        }
        .history-modal.is-visible { opacity: 1; visibility: visible; transition-delay: 0s; }
        .history-container {
            width: 90%; max-width: 700px; max-height: 80vh; border-radius: 8px; padding: 1.5rem 2rem;
            display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: scale(0.95); transition: transform 0.3s, background-color 0.4s;
        }
        .light-mode .history-container { background-color: var(--content-bg-light); }
        .dark-mode .history-container { background-color: var(--content-bg-dark); }
        .history-modal.is-visible .history-container { transform: scale(1); }

        .history-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; margin-bottom: 1rem; border-bottom: 1px solid; }
        .light-mode .history-header { border-color: var(--border-color-light); }
        .dark-mode .history-header { border-color: var(--border-color-dark); }
        .history-header h2 { font-size: 1.5rem; font-weight: 500; }
        
        .history-controls { display: flex; gap: 1rem; margin-bottom: 1rem; }
        #history-search { flex-grow: 1; padding: 0.5rem 0.75rem; border-radius: 5px; font-size: 1rem; font-family: var(--font-sans); }
        #history-sort { padding: 0.5rem; border-radius: 5px; font-size: 1rem; font-family: var(--font-sans); }
        .light-mode #history-search, .light-mode #history-sort { background-color: var(--bg-color-light); border: 1px solid var(--border-color-light); color: var(--text-primary-light); }
        .dark-mode #history-search, .dark-mode #history-sort { background-color: var(--bg-color-dark); border: 1px solid var(--border-color-dark); color: var(--text-primary-dark); }
        #history-search:focus, #history-sort:focus { outline: none; border-color: var(--accent-color); }
        
        .history-list { list-style: none; overflow-y: auto; flex-grow: 1; }
        .history-list li { padding: 1rem; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; border-bottom: 1px solid; }
        .history-list li:last-child { border-bottom: none; }
        .history-list-item-title { font-family: var(--font-serif); font-size: 1.2rem; font-weight: 600; }
        .history-list-item-author { font-family: var(--font-sans); font-size: 0.9rem; margin-top: 0.25rem; }
        .light-mode .history-list li { border-color: var(--border-color-light); }
        .dark-mode .history-list li { border-color: var(--border-color-dark); }
        .light-mode .history-list li:hover { background-color: var(--bg-color-light); }
        .dark-mode .history-list li:hover { background-color: var(--bg-color-dark); }
        .light-mode .history-list-item-author { color: var(--text-secondary-light); }
        .dark-mode .history-list-item-author { color: var(--text-secondary-dark); }

        .no-history-msg { padding: 2rem; text-align: center; }
        .light-mode .no-history-msg { color: var(--text-secondary-light); }
        .dark-mode .no-history-msg { color: var(--text-secondary-dark); }

        /* --- 10. 響應式設計 (Responsive Design) --- */
        @media (max-width: 768px) {
            .page-container { padding: 1rem 0; }
            .settings-card, .reader-card { padding: 1.5rem; border-radius: 0; border-left: none; border-right: none; box-shadow: none; }
            body.fullscreen-mode .reader-card { padding: 1rem; }
            .settings-header { margin-bottom: 1.5rem; }
            .settings-header .title-group h1 { font-size: 1.8rem; }
            .settings-header .header-controls { top: -8px; right: -8px; }
            .page-content { padding: 1.5rem; line-height: 1.9; }
            .page-content h2.article-title { font-size: 1.5rem; }
            .history-controls { flex-direction: column; }
        }
    </style>
</head>
<body class="light-mode">

    <!-- NEW: Password Overlay -->
    <div id="password-overlay" class="password-overlay">
        <div id="password-modal" class="password-modal">
            <h2>請輸入密碼登入</h2>
 
            <form id="password-form">
                <input type="password" id="password-input" placeholder="••••••••" required autocomplete="current-password">
                <button type="submit" id="password-submit-btn">登入</button>
            </form>
            <p id="password-error" class="password-error hidden">密碼錯誤，請重試。</p>
        </div>
    </div>

    <!-- Main Content (Initially Hidden) -->
    <div class="page-container hidden">
        <div class="main-content-wrapper">
            <!-- 設定卡片 (初始顯示) -->
            <section class="settings-card" id="settings-section">
                <header class="settings-header">
                    <div class="title-group">
                        <h1>經典散文・閱讀器</h1>
                        <p>與文學巨擘對話，探索思想的深度</p>
                    </div>
                    <div class="header-controls">
                        <button class="icon-btn" id="history-btn" title="閱覽紀錄">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M2.5 2v6h6M2.66 15.57a10 10 0 1 0 .57-8.38"/></svg>
                        </button>
                    </div>
                </header>
                <form id="prose-form">
                    <div class="form-group">
                        <label for="difficulty">文學鑑賞難度<span class="required-indicator">*</span></label>
                        <div class="rating-dots" id="difficulty-rating" data-rating="0">
                            <div class="rating-dot" data-value="1"></div><div class="rating-dot" data-value="2"></div>
                            <div class="rating-dot" data-value="3"></div><div class="rating-dot" data-value="4"></div>
                            <div class="rating-dot" data-value="5"></div>
                        </div>
                        <div id="error-message">請選擇一個鑑賞難度</div>
                    </div>
                    <div class="form-group">
                        <label for="prompt">作品主題或風格 (選填)</label>
                        <textarea id="prompt" placeholder="輸入作品主題或風格..."></textarea>
                    </div>
                    <button type="submit" id="generate-btn" class="submit-btn">
                        <span>尋找經典</span>
                    </button>
                </form>
            </section>
            
            <!-- 閱讀器卡片 (初始隱藏) -->
            <section class="reader-card hidden" id="reading-section">
                <div class="reader-controls">
                     <div class="left-controls">
                        <button class="icon-btn" id="back-to-settings-btn" title="返回設定">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                        </button>
                    </div>
                    <div class="right-controls">
                         <button class="icon-btn" id="theme-switcher" title="切換主題">
                           <svg class="icon-theme-light" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                           <svg class="icon-theme-dark hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                        </button>
                        <button class="icon-btn fullscreen-btn" id="fullscreen-btn" title="全螢幕模式">
                            <svg class="icon-enter-fullscreen" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
                            <svg class="icon-exit-fullscreen" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 0-2-2h-3m-12 0H5a2 2 0 0 0-2 2v3"></path></svg>
                        </button>
                    </div>
                </div>
                <div class="book-container" id="book-container">
                    <div class="book" id="book"></div>
                </div>
                <div id="sizer"></div>
            </section>
        </div>
    </div>

    <!-- 歷史紀錄彈出層 (Modal) -->
    <div class="history-modal" id="history-modal">
        <div class="history-container">
            <div class="history-header">
                <h2>閱覽紀錄</h2>
                <button class="icon-btn" id="history-close-btn" title="關閉">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="history-controls">
                <input type="search" id="history-search" placeholder="搜尋標題或作者...">
                <select id="history-sort">
                    <option value="date_desc">按生成日期 (新到舊)</option>
                    <option value="date_asc">按生成日期 (舊到新)</option>
                    <option value="stroke_asc">按作家姓名筆劃 (少到多)</option>
                    <option value="stroke_desc">按作家姓名筆劃 (多到少)</option>
                </select>
            </div>
            <ul class="history-list" id="history-list"></ul>
        </div>
    </div>

    <script>
    // --- NEW: Firebase Configuration ---
    const firebaseConfig = {
      apiKey: "AIzaSyAOTRmML2Zje5e6DYihpExkRiVgJuuTFHQ",
      authDomain: "password-c344c.firebaseapp.com",
      databaseURL: "https://password-c344c-default-rtdb.firebaseio.com", // Added for Realtime Database
      projectId: "password-c344c",
      storageBucket: "password-c344c.firebasestorage.app",
      messagingSenderId: "1056032198970",
      appId: "1:1056032198970:web:fd3f821d4c2738bdab8003"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // --- NEW: Main application logic is now in a function ---
    function initializeApp() {
        // --- 1. DOM 元素選擇 ---
        const body = document.body;
        const settingsSection = document.getElementById('settings-section');
        const readingSection = document.getElementById('reading-section');
        const themeSwitcher = document.getElementById('theme-switcher');
        const lightThemeIcon = themeSwitcher.querySelector('.icon-theme-light');
        const darkThemeIcon = themeSwitcher.querySelector('.icon-theme-dark');
        const proseForm = document.getElementById('prose-form');
        const difficultyRating = document.getElementById('difficulty-rating');
        const ratingDots = difficultyRating.querySelectorAll('.rating-dot');
        const errorMessage = document.getElementById('error-message');
        const promptTextarea = document.getElementById('prompt');
        const generateBtn = document.getElementById('generate-btn');
        const book = document.getElementById('book');
        const bookContainer = document.getElementById('book-container');
        const sizer = document.getElementById('sizer');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const backToSettingsBtn = document.getElementById('back-to-settings-btn');
        const historyBtn = document.getElementById('history-btn');
        const historyModal = document.getElementById('history-modal');
        const historyCloseBtn = document.getElementById('history-close-btn');
        const historyList = document.getElementById('history-list');
        const historySearch = document.getElementById('history-search');
        const historySort = document.getElementById('history-sort');

        // --- API 配置信息 ---
        const API_KEYS = ["sk-GruTbLTbtSeWof3rEBjtIg"];
        let currentApiKeyIndex = 0;
        const API_URL = "https://chatapi.akash.network/api/v1/chat/completions";
        const MODEL = "DeepSeek-R1-0528";

        // --- 2. 狀態管理 ---
        let state = {
            difficulty: 0,
            history: JSON.parse(localStorage.getItem('proseHistory_v3')) || [],
            currentArticle: null,
            currentPageNum: 0,
            totalPages: 0,
        };
        let isDragging = false, dragStartX = 0, currentTranslate = 0, startTranslate = 0;

        // --- 3. 初始化 ---
        const initTheme = () => {
            const savedTheme = localStorage.getItem('theme') || 'light-mode';
            body.className = savedTheme;
            lightThemeIcon.classList.toggle('hidden', savedTheme === 'dark-mode');
            darkThemeIcon.classList.toggle('hidden', savedTheme === 'light-mode');
        };
        initTheme();
        
        // --- 4. 事件監聽器 ---
        themeSwitcher.addEventListener('click', () => {
            const isLight = body.classList.contains('light-mode');
            body.className = isLight ? 'dark-mode' : 'light-mode';
            localStorage.setItem('theme', body.className);
            lightThemeIcon.classList.toggle('hidden');
            darkThemeIcon.classList.toggle('hidden');
        });

        ratingDots.forEach(dot => {
            dot.addEventListener('click', () => {
                state.difficulty = parseInt(dot.dataset.value);
                difficultyRating.dataset.rating = state.difficulty;
                errorMessage.style.display = 'none';
                updateRatingDots();
            });
            dot.addEventListener('mouseover', () => {
                const hoverValue = parseInt(dot.dataset.value);
                ratingDots.forEach(d => d.classList.toggle('selected', d.dataset.value <= hoverValue));
            });
        });
        difficultyRating.addEventListener('mouseout', updateRatingDots);

        proseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (state.difficulty === 0) {
                errorMessage.style.display = 'block';
                return;
            }
            setLoading(true);
            try {
                const article = await generateProse();
                if (article) {
                    state.currentArticle = { ...article, generatedDate: new Date().toISOString() };
                    addToHistory(state.currentArticle);
                    displayArticleAsBook(state.currentArticle);
                    switchToReaderView();
                    if (!body.classList.contains('fullscreen-mode')) {
                         toggleFullscreen();
                    }
                }
            } catch (error) {
                console.error('生成文章時發生錯誤:', error);
                alert(`生成失敗: ${error.message}`);
            } finally {
                setLoading(false);
            }
        });

        fullscreenBtn.addEventListener('click', toggleFullscreen);
        backToSettingsBtn.addEventListener('click', () => {
            if (body.classList.contains('fullscreen-mode')) toggleFullscreen();
            switchToSettingsView();
        });

        historyBtn.addEventListener('click', showHistory);
        historyCloseBtn.addEventListener('click', hideHistory);
        historyModal.addEventListener('click', (e) => { if (e.target === historyModal) hideHistory(); });
        historyList.addEventListener('click', handleHistoryItemClick);
        historySearch.addEventListener('input', renderHistory);
        historySort.addEventListener('change', renderHistory);
        
        bookContainer.addEventListener('mousedown', dragStart);
        bookContainer.addEventListener('touchstart', dragStart, { passive: true });
        document.addEventListener('mousemove', dragMove);
        document.addEventListener('touchmove', dragMove, { passive: true });
        document.addEventListener('mouseup', dragEnd);
        document.addEventListener('touchend', dragEnd);

        // --- 5. 核心功能函式 ---
        function updateRatingDots() {
            ratingDots.forEach(dot => {
                dot.classList.toggle('selected', dot.dataset.value <= state.difficulty);
            });
        }
        
        function setLoading(isLoading) {
            generateBtn.disabled = isLoading;
            const span = generateBtn.querySelector('span');
            if (isLoading) {
                span.style.display = 'none';
                if (!generateBtn.querySelector('.loader')) {
                    const loader = document.createElement('div');
                    loader.className = 'loader';
                    generateBtn.appendChild(loader);
                }
            } else {
                span.style.display = 'inline';
                const loader = generateBtn.querySelector('.loader');
                if (loader) loader.remove();
            }
        }

        function switchToReaderView() {
            settingsSection.classList.add('hidden');
            readingSection.classList.remove('hidden');
        }

        function switchToSettingsView() {
            readingSection.classList.add('hidden');
            settingsSection.classList.remove('hidden');
        }

        function toggleFullscreen() { body.classList.toggle('fullscreen-mode'); }

        async function generateProse() {
            const userPrompt = promptTextarea.value.trim();
            const systemPrompt = `你是一位精通世界文學的圖書館員。你的任務是根據用戶要求，從浩瀚的文學作品中，找出一段真實、經典的繁體中文散文。
用戶的文學鑑賞難度偏好（1星最淺白，5星最艱深）：${state.difficulty}顆星。
${userPrompt ? `用戶的個性化要求： "${userPrompt}"` : `請隨機推薦一篇符合上述難度的經典散文。`}

重要指示：
1. 你必須找出現實世界中，由真實作家所寫的著名散文作品。禁止虛構內容。
2. 作品內容必須是完整的段落或一篇適合一次閱讀完畢的作品(5000字以內)。
3. 你的回傳內容必須嚴格遵循以下 JSON 格式，不要包含任何 markdown 語法或額外說明。
4. 所有文字都必須是繁體中文。
5. [作品賞析] 必須針對你推薦的這篇真實作品進行分析，可包含作者背景、寫作風格、或該作品的歷史意義。

JSON 格式如下：
{
  "title": "{這裡填寫真實的作品標題}",
  "author": "{這裡填寫真實的作家姓名}",
  "outline": "{這裡填寫一段約 50 字的真實作品綱要或引言}",
  "content": "{這裡貼上完整的真實散文內容，段落之間用 \\n 分隔}",
  "appreciation": {
    "title": "作品賞析",
    "text": "{這裡填寫對這篇真實作品的賞析內容}"
  }
}`;
            
            const currentKey = API_KEYS[currentApiKeyIndex];
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentKey}` },
                body: JSON.stringify({
                    model: MODEL,
                    messages: [{ role: "user", content: systemPrompt }],
                    response_format: { type: "json_object" },
                    max_tokens: 64000,
                    temperature: 0.8
                })
            });

            if (!response.ok) {
                if (response.status === 401) {
                    currentApiKeyIndex = (currentApiKeyIndex + 1) % API_KEYS.length;
                    if (currentApiKeyIndex !== 0) {
                        console.warn(`API Key 失效，正在嘗試下一個 Key...`);
                        return await generateProse();
                    } else {
                        throw new Error(`API 請求失敗 (401 Unauthorized): 所有 API Key 皆已失效或無效。`);
                    }
                }
                throw new Error(`API 請求失敗，狀態碼：${response.status}`);
            }
            
            currentApiKeyIndex = 0; 
            const data = await response.json();
            const contentString = data.choices[0].message.content;
            if (!contentString) throw new Error("API 未返回有效內容。");
            const article = JSON.parse(contentString);
            if (!article.title || !article.author || !article.content) throw new Error("API 回應格式不正確，無法解析文章。");
            return article;
        }

        function addToHistory(article) {
            state.history = state.history.filter(item => item.title !== article.title);
            state.history.unshift(article);
            if (state.history.length > 50) state.history.pop();
            localStorage.setItem('proseHistory_v3', JSON.stringify(state.history));
        }

        // --- 6. 書本與分頁邏輯 ---
        function paginateArticle(article) {
            const containerWidth = bookContainer.clientWidth;
            const containerHeight = bookContainer.clientHeight;
            if (containerWidth === 0 || containerHeight === 0) {
                console.error("Book container has no size. Cannot paginate.");
                return ["錯誤：無法計算頁面尺寸。"];
            }

            sizer.style.width = containerWidth + 'px';
            sizer.style.height = containerHeight + 'px';
            
            const firstPageHeader = `<h2 class="article-title">${article.title}</h2><p class="article-author">文 / ${article.author}</p><div class="article-outline">${article.outline}</div>`;
            const fullContent = article.content.replace(/\n/g, '<p></p>') + `<div class="article-appreciation"><h3>${article.appreciation.title}</h3><p>${article.appreciation.text}</p></div>`;
            
            const contentDoc = new DOMParser().parseFromString(`<div>${fullContent}</div>`, 'text/html');
            const contentNodes = Array.from(contentDoc.body.firstChild.childNodes);
            
            let pages = [];
            let currentPageHTML = firstPageHeader;
            sizer.innerHTML = currentPageHTML;

            for (const node of contentNodes) {
                const nodeHTML = node.outerHTML || node.textContent;
                sizer.innerHTML += nodeHTML;
                
                if (sizer.scrollHeight > sizer.clientHeight) {
                    pages.push(currentPageHTML);
                    currentPageHTML = nodeHTML;
                    sizer.innerHTML = currentPageHTML;
                } else {
                    currentPageHTML += nodeHTML;
                }
            }
            pages.push(currentPageHTML);
            return pages;
        }

        function displayArticleAsBook(article) {
            book.innerHTML = '';
            book.style.transition = 'none';
            setTimeout(() => {
                const pagesContent = paginateArticle(article);
                state.totalPages = pagesContent.length;
                pagesContent.forEach((content, i) => {
                    const pageElement = document.createElement('div');
                    pageElement.className = 'page';
                    pageElement.innerHTML = `<div class="page-content">${content}<span class="page-number">${i + 1} / ${state.totalPages}</span></div>`;
                    book.appendChild(pageElement);
                });
                goToPage(0);
            }, 50);
        }

        function goToPage(pageNum) {
            const pageIndex = Math.max(0, Math.min(pageNum, state.totalPages - 1));
            state.currentPageNum = pageIndex;
            currentTranslate = -pageIndex * bookContainer.clientWidth;
            book.style.transition = 'transform 0.4s ease-out';
            book.style.transform = `translateX(${currentTranslate}px)`;
        }

        // --- 7. 翻頁互動處理 ---
        function dragStart(e) {
            isDragging = true;
            dragStartX = e.touches ? e.touches[0].clientX : e.clientX;
            startTranslate = currentTranslate;
            book.style.transition = 'none';
        }

        function dragMove(e) {
            if (!isDragging) return;
            const currentX = e.touches ? e.touches[0].clientX : e.clientX;
            const diff = currentX - dragStartX;
            currentTranslate = startTranslate + diff;
            book.style.transform = `translateX(${currentTranslate}px)`;
        }

        function dragEnd() {
            if (!isDragging) return;
            isDragging = false;
            const threshold = bookContainer.clientWidth / 5;
            const endTranslate = -state.currentPageNum * bookContainer.clientWidth;
            const movedBy = currentTranslate - endTranslate;

            if (movedBy < -threshold) goToPage(state.currentPageNum + 1);
            else if (movedBy > threshold) goToPage(state.currentPageNum - 1);
            else goToPage(state.currentPageNum);
        }

        // --- 8. 歷史紀錄相關函式 ---
        function showHistory() { renderHistory(); historyModal.classList.add('is-visible'); }
        function hideHistory() { historyModal.classList.remove('is-visible'); }
        
        function renderHistory() {
            let items = [...state.history];
            const term = historySearch.value.toLowerCase();
            if (term) items = items.filter(i => i.title.toLowerCase().includes(term) || i.author.toLowerCase().includes(term));
            
            const collator = new Intl.Collator('zh-Hant', { sensitivity: 'base', collation: 'stroke' });
            items.sort((a, b) => {
                switch (historySort.value) {
                    case 'date_asc': return new Date(a.generatedDate) - new Date(b.generatedDate);
                    case 'stroke_asc': return collator.compare(a.author, b.author);
                    case 'stroke_desc': return collator.compare(b.author, a.author);
                    default: return new Date(b.generatedDate) - new Date(a.generatedDate);
                }
            });

            historyList.innerHTML = items.length === 0 
                ? `<li class="no-history-msg">${term ? '找不到符合條件的紀錄。' : '目前沒有閱覽紀錄。'}</li>`
                : items.map(item => `<li data-history-title="${item.title}">
                                        <div class="history-list-item-title">${item.title}</div>
                                        <div class="history-list-item-author">${item.author}</div>
                                     </li>`).join('');
        }
        
        function handleHistoryItemClick(e) {
            const li = e.target.closest('li[data-history-title]');
            if (!li) return;
            const article = state.history.find(item => item.title === li.dataset.historyTitle);
            if (article) {
                state.currentArticle = article;
                displayArticleAsBook(article);
                switchToReaderView();
                hideHistory();
                setTimeout(() => { if (!body.classList.contains('fullscreen-mode')) toggleFullscreen(); }, 300);
            }
        }
    }

    // --- NEW: Password validation logic on page load ---
    document.addEventListener('DOMContentLoaded', () => {
        const passwordOverlay = document.getElementById('password-overlay');
        const passwordForm = document.getElementById('password-form');
        const passwordInput = document.getElementById('password-input');
        const passwordError = document.getElementById('password-error');
        const passwordSubmitBtn = document.getElementById('password-submit-btn');
        const pageContainer = document.querySelector('.page-container');

        // Apply saved theme to the password page itself
        const savedTheme = localStorage.getItem('theme') || 'light-mode';
        document.body.className = savedTheme;
        passwordInput.focus();

        passwordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            passwordError.classList.add('hidden');
            passwordSubmitBtn.disabled = true;
            passwordSubmitBtn.textContent = '驗證中...';

            const enteredPassword = passwordInput.value;
            const passwordRef = database.ref('password'); // Get reference to 'password' key in DB

            passwordRef.once('value').then((snapshot) => {
                const correctPassword = snapshot.val();
                if (enteredPassword === correctPassword) {
                    // Correct password
                    passwordOverlay.style.opacity = '0';
                    passwordOverlay.style.visibility = 'hidden';
                    pageContainer.classList.remove('hidden');
                    initializeApp(); // Run the main app logic
                } else {
                    // Incorrect password
                    passwordError.classList.remove('hidden');
                    passwordInput.value = '';
                    passwordInput.focus();
                    passwordSubmitBtn.disabled = false;
                    passwordSubmitBtn.textContent = '登入';
                }
            }).catch((error) => {
                console.error("Firebase read failed: " + error.message);
                alert("無法驗證密碼，請檢查網絡連線或聯繫管理員。");
                passwordSubmitBtn.disabled = false;
                passwordSubmitBtn.textContent = '登入';
            });
        });
    });
    </script>
</body>
</html>
