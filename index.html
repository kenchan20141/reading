<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小說散文・節錄</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. 核心與主題設定 (Core & Theming) --- */
        :root {
            --bg-color-light: #F4F4F3;
            --text-primary-light: #2c3e50;
            --text-secondary-light: #7f8c8d;
            --content-bg-light: #FFFFFF;
            --border-color-light: #EAEAEA;
            --accent-color: #2980b9;
            --accent-color-hover: #3498db;
            
            --bg-color-dark: #1F1F1F;
            --text-primary-dark: #D1CFCB;
            --text-secondary-dark: #888888;
            --content-bg-dark: #2A2A2A;
            --border-color-dark: #444444;

            --overlay-bg: rgba(44, 62, 80, 0.7);

            --font-sans: 'Noto Sans TC', sans-serif;
            --font-serif: 'Noto Serif TC', serif;
            --max-width: 1100px;

            --reader-font-size: 1.1rem;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-sans);
            transition: background-color 0.4s, color 0.4s;
            line-height: 1.8;
            font-size: 16px;
        }
        
        body.light-mode {
            background-color: var(--bg-color-light);
            color: var(--text-primary-light);
        }

        body.dark-mode {
            background-color: var(--bg-color-dark);
            color: var(--text-primary-dark);
        }

        /* --- 2. 全域版面與容器 (Global Layout & Containers) --- */
        .page-container {
            display: grid;
            place-items: center;
            min-height: 100vh;
            padding: 2rem 1rem;
        }
        
        .hidden { display: none !important; }

        /* --- 3. UI 控制項 (UI Controls & Icons) --- */
        .icon-btn {
            background: none; border: none; cursor: pointer;
            padding: 0.5rem; border-radius: 50%;
            display: inline-flex; justify-content: center; align-items: center;
            transition: background-color 0.2s, transform 0.2s;
        }
        .icon-btn svg {
            width: 24px; height: 24px; stroke-width: 1.5;
            transition: stroke 0.2s, fill 0.2s;
        }
        .light-mode .icon-btn svg { stroke: var(--text-primary-light); }
        .dark-mode .icon-btn svg { stroke: var(--text-primary-dark); }
        .light-mode .icon-btn:hover { background-color: rgba(0,0,0,0.05); }
        .dark-mode .icon-btn:hover { background-color: var(--content-bg-dark); }
        .icon-btn:hover { transform: scale(1.1); }
        .fullscreen-btn .icon-exit-fullscreen { display: none; }
        
        /* --- 4. 主要區塊：設定、閱讀器 (Main Sections: Settings, Reader) --- */
        .main-content-wrapper { width: 100%; max-width: var(--max-width); transition: all 0.4s ease-in-out; }
        .settings-card, .reader-card {
            border: 1px solid; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            padding: 2rem 3rem;
            transition: background-color 0.4s, border-color 0.4s;
        }
        .light-mode .settings-card, .light-mode .reader-card { background-color: var(--content-bg-light); border-color: var(--border-color-light); }
        .dark-mode .settings-card, .dark-mode .reader-card { background-color: var(--content-bg-dark); border-color: var(--border-color-dark); }
        
        /* --- 5. 設定區塊樣式 (Settings Section Styles) --- */
        .settings-header { display: flex; justify-content: space-between; align-items: flex-start; position: relative; margin-bottom: 2.5rem; }
        .settings-header .title-group { text-align: center; width: 100%; }
        .settings-header .title-group h1 { font-family: var(--font-serif); font-weight: 600; font-size: 2rem; margin-bottom: 0.5rem; }
        .settings-header .title-group p { font-size: 1rem; }
        .light-mode .settings-header .title-group p { color: var(--text-secondary-light); }
        .dark-mode .settings-header .title-group p { color: var(--text-secondary-dark); }
        .settings-header .header-controls { position: absolute; top: -12px; right: -16px; display: flex; align-items: center; gap: 0.25rem; }
        .form-group { margin-bottom: 2rem; }
        .form-group label { display: block; margin-bottom: 0.75rem; font-weight: 500; font-size: 1.1rem; }
        .rating-dots { display: flex; gap: 12px; cursor: pointer; }
        .rating-dot { width: 28px; height: 28px; border-radius: 50%; border: 2px solid; transition: all 0.2s ease-in-out; }
        .light-mode .rating-dot { border-color: #ccc; }
        .dark-mode .rating-dot { border-color: #555; }
        .rating-dots:hover .rating-dot, .rating-dots .rating-dot.selected { border-color: var(--accent-color); background-color: var(--accent-color); transform: scale(1.1); }
        .rating-dots:hover .rating-dot:hover ~ .rating-dot { background-color: transparent; border-color: #ccc; }
        .dark-mode .rating-dots:hover .rating-dot:hover ~ .rating-dot { border-color: #555; }
        .required-indicator { color: #e74c3c; margin-left: 4px; }
        #error-message { color: #e74c3c; margin-top: 0.5rem; display: none; font-size: 0.9rem; }
        textarea {
            width: 100%; min-height: 100px; padding: 0.75rem 1rem; border-radius: 5px;
            font-family: inherit; font-size: 1rem; line-height: 1.6;
            transition: background-color 0.4s, color 0.4s, border-color 0.4s;
        }
        .light-mode textarea { background-color: var(--bg-color-light); border: 1px solid var(--border-color-light); color: var(--text-primary-light); }
        .dark-mode textarea { background-color: var(--bg-color-dark); border: 1px solid var(--border-color-dark); color: var(--text-primary-dark); }
        textarea:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 2px rgba(41, 128, 185, 0.3); }
        
        /* --- NEW: Select dropdown styles --- */
        select {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 5px;
            font-family: inherit;
            font-size: 1rem;
            line-height: 1.6;
            transition: background-color 0.4s, color 0.4s, border-color 0.4s;
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: .65em auto;
            cursor: pointer;
        }
        .light-mode select {
            background-color: var(--bg-color-light);
            border: 1px solid var(--border-color-light);
            color: var(--text-primary-light);
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%232c3e50%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-13%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2013l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
        }
        .dark-mode select {
            background-color: var(--bg-color-dark);
            border: 1px solid var(--border-color-dark);
            color: var(--text-primary-dark);
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23D1CFCB%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-13%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2013l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
        }
        select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(41, 128, 185, 0.3);
        }

        .submit-btn {
            background-color: var(--accent-color); color: white; border: none; padding: 0.75rem 1.75rem; border-radius: 5px; cursor: pointer;
            font-family: inherit; font-size: 1.1rem; font-weight: 500; transition: background-color 0.3s, transform 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 10px; width: 100%; margin-top: 1rem;
        }
        .submit-btn .btn-text { transition: opacity 0.2s; }
        .submit-btn:hover { background-color: var(--accent-color-hover); }
        .submit-btn:active { transform: scale(0.98); }
        .submit-btn:disabled { background-color: #cccccc; cursor: not-allowed; }
        .loader { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- 6. 閱讀器頂部控制列 (Reader Header Controls) --- */
        .reader-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding: 0 0.5rem; }
        .reader-controls .left-controls, .reader-controls .right-controls { display: flex; align-items: center; gap: 0.5rem; }
        
        .reader-pagination {
            font-family: var(--font-sans);
            font-size: 0.9rem;
            text-align: center;
        }
        .light-mode .reader-pagination { color: var(--text-secondary-light); }
        .dark-mode .reader-pagination { color: var(--text-secondary-dark); }

        .font-controls { display: flex; align-items: center; gap: 0.25rem; border-right: 1px solid; padding-right: 0.75rem; margin-right: 0.25rem;}
        .light-mode .font-controls { border-color: var(--border-color-light); }
        .dark-mode .font-controls { border-color: var(--border-color-dark); }
        .font-controls .icon-btn svg { width: 22px; height: 22px; }

        /* --- 7. 書本閱讀器 (Book Reader) --- */
        .book-container { width: 100%; height: 75vh; min-height: 550px; display: flex; justify-content: center; align-items: center; overflow: hidden; user-select: none; cursor: grab; margin-top: 0; margin-bottom: 2.5rem; }
        .book-container:active { cursor: grabbing; }
        .book { width: 100%; height: 100%; display: flex; }
        .page { width: 100%; height: 100%; flex-shrink: 0; position: relative; border: 1px solid; }
        
        .page-content { 
            width: 100%; height: 100%; 
            padding: 3.5rem 3rem; /* 修訂 #1: 增加上下內距 */
            overflow-y: auto; 
            font-family: var(--font-serif); 
            font-size: var(--reader-font-size); 
            letter-spacing: 0.05em; 
            line-height: 2;
            display: flex;
            flex-direction: column;
            /* justify-content: center; 修訂 #1: 移除，讓文字從頂部開始 */
        }
        .light-mode .page { background: var(--content-bg-light); border-color: var(--border-color-light); }
        .dark-mode .page { background: var(--content-bg-dark); border-color: var(--border-color-dark); }
        .light-mode .page-content { color: var(--text-primary-light); }
        .dark-mode .page-content { color: var(--text-primary-dark); }
        .page-content h2.article-title { font-size: calc(var(--reader-font-size) + 0.9rem); font-weight: 600; margin-bottom: 0.75rem; text-align: center; }
        .page-content p.article-author { font-family: var(--font-sans); font-size: calc(var(--reader-font-size) - 0.1rem); margin-bottom: 1.5rem; text-align: center; color: var(--accent-color); }
        .page-content .article-outline { font-family: var(--font-sans); font-style: italic; font-size: calc(var(--reader-font-size) - 0.1rem); text-align: center; margin: 1rem 0 2rem 0; padding-bottom: 2rem; border-bottom: 1px solid; }
        .light-mode .page-content .article-outline { color: var(--text-secondary-light); border-color: var(--border-color-light); }
        .dark-mode .page-content .article-outline { color: var(--text-secondary-dark); border-color: var(--border-color-dark); }

        .page-content p { margin-bottom: 1em; }
        .page-content p.article-author { margin-bottom: 1.5rem; }
        .page-content p:last-child { margin-bottom: 0; }

        .article-appreciation { margin-top: 0rem; padding-top: 0rem; border-top: 1px solid; }
        .light-mode .article-appreciation { border-color: var(--border-color-light); }
        .dark-mode .article-appreciation { border-color: var(--border-color-dark); }
        .article-appreciation h3 { font-family: var(--font-sans); font-weight: 500; font-size: calc(var(--reader-font-size) + 0.15rem); margin-bottom: 1rem; }
        
        #sizer { position: absolute; visibility: hidden; z-index: -100; overflow: hidden; font-family: var(--font-serif); font-size: var(--reader-font-size); letter-spacing: 0.05em; line-height: 2; padding: 3.5rem 3rem; /* 修訂 #1: 與 page-content 同步 */ }

        /* --- 插圖樣式 (Illustration Styles) --- */
        .illustration-container {
            width: 85%;
            margin: 2.5rem auto;
            padding: 1rem;
            border: 1px dashed;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            page-break-inside: avoid;
            cursor: pointer;
        }
        .light-mode .illustration-container { border-color: var(--border-color-light); }
        .dark-mode .illustration-container { border-color: var(--border-color-dark); }
        .illustration-container img { max-width: 100%; height: auto; border-radius: 4px; transition: opacity 0.3s; }
        .illustration-container img:hover { opacity: 0.85; }
        .illustration-loader { display: flex; align-items: center; gap: 15px; cursor: default; }
        .illustration-loader .spinner { width: 30px; height: 30px; border: 4px solid rgba(0,0,0,0.1); border-radius: 50%; animation: spin 1s linear infinite; }
        .light-mode .illustration-loader .spinner { border-top-color: var(--text-secondary-light); }
        .dark-mode .illustration-loader .spinner { border-top-color: var(--text-secondary-dark); }
        .light-mode .illustration-loader p { color: var(--text-secondary-light); }
        .dark-mode .illustration-loader p { color: var(--text-secondary-dark); }
        .illustration-error { text-align: center; padding: 1rem; }
        .illustration-error svg { width: 40px; height: 40px; margin-bottom: 1rem; stroke: #e74c3c; }
        .illustration-error p { font-family: var(--font-sans); font-size: 0.9rem; color: #e74c3c; line-height: 1.6; }

        .page-content--illustration {
            padding: 0 !important;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .page-content--illustration .illustration-container {
            margin: 1rem;
            width: 90%;
            height: 90%;
            border-style: solid;
        }
        .page-content--illustration .illustration-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        /* --- 8. 全螢幕模式 (Fullscreen Mode) --- */
        body.fullscreen-mode { overflow: hidden; }
        body.light-mode.fullscreen-mode { background-color: var(--content-bg-light); }
        body.dark-mode.fullscreen-mode { background-color: var(--content-bg-dark); }
        body.fullscreen-mode .page-container { padding: 0; }
        body.fullscreen-mode .main-content-wrapper { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; max-width: none; z-index: 1000; }
        body.fullscreen-mode .reader-card { border-radius: 0; border: none; box-shadow: none; height: 100%; display: flex; flex-direction: column; padding: 2rem; }
        body.fullscreen-mode .book-container { flex-grow: 1; min-height: auto; height: auto; }
        body.fullscreen-mode .fullscreen-btn .icon-enter-fullscreen { display: none; }
        body.fullscreen-mode .fullscreen-btn .icon-exit-fullscreen { display: block; }
        
        /* --- 9. 歷史紀錄彈窗 (History Modal) --- */
        .history-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--overlay-bg);
            display: flex; justify-content: center; align-items: center; z-index: 2000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0s 0.3s;
        }
        .history-modal.is-visible { opacity: 1; visibility: visible; transition-delay: 0s; }
        .history-container {
            width: 90%; max-width: 700px; max-height: 80vh; border-radius: 8px; padding: 1.5rem 2rem;
            display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: scale(0.95); transition: transform 0.3s, background-color 0.4s;
        }
        .light-mode .history-container { background-color: var(--content-bg-light); }
        .dark-mode .history-container { background-color: var(--content-bg-dark); }
        .history-modal.is-visible .history-container { transform: scale(1); }
        .history-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; margin-bottom: 1rem; border-bottom: 1px solid; }
        .light-mode .history-header { border-color: var(--border-color-light); }
        .dark-mode .history-header { border-color: var(--border-color-dark); }
        .history-header h2 { font-size: 1.5rem; font-weight: 500; }
        .history-controls { display: flex; gap: 1rem; margin-bottom: 1rem; }
        #history-search { flex-grow: 1; padding: 0.5rem 0.75rem; border-radius: 5px; font-size: 1rem; font-family: var(--font-sans); }
        #history-sort { padding: 0.5rem; border-radius: 5px; font-size: 1rem; font-family: var(--font-sans); }
        .light-mode #history-search, .light-mode #history-sort { background-color: var(--bg-color-light); border: 1px solid var(--border-color-light); color: var(--text-primary-light); }
        .dark-mode #history-search, .dark-mode #history-sort { background-color: var(--bg-color-dark); border: 1px solid var(--border-color-dark); color: var(--text-primary-dark); }
        #history-search:focus, #history-sort:focus { outline: none; border-color: var(--accent-color); }
        .history-list { list-style: none; overflow-y: auto; flex-grow: 1; }
        .history-list li { display: flex; justify-content: space-between; align-items: center; gap: 1rem; padding: 1rem; border-radius: 5px; transition: background-color 0.2s; border-bottom: 1px solid; }
        .history-list li:last-child { border-bottom: none; }
        .history-item-content { flex-grow: 1; cursor: pointer; }
        .history-list-item-title { font-family: var(--font-serif); font-size: 1.2rem; font-weight: 600; }
        .history-list-item-meta { font-family: var(--font-sans); font-size: 0.9rem; margin-top: 0.25rem; }
        .light-mode .history-list li { border-color: var(--border-color-light); }
        .dark-mode .history-list li { border-color: var(--border-color-dark); }
        .light-mode .history-item-content:hover { background-color: var(--bg-color-light); }
        .dark-mode .history-item-content:hover { background-color: var(--bg-color-dark); }
        .light-mode .history-list-item-meta { color: var(--text-secondary-light); }
        .dark-mode .history-list-item-meta { color: var(--text-secondary-dark); }
        .delete-history-btn svg { width: 20px; height: 20px; }
        .light-mode .delete-history-btn:hover svg, #delete-all-history-btn:hover svg { stroke: #e74c3c; }
        .dark-mode .delete-history-btn:hover svg, #delete-all-history-btn:hover svg { stroke: #e74c3c; }
        .no-history-msg { padding: 2rem; text-align: center; justify-content: center; }
        .light-mode .no-history-msg { color: var(--text-secondary-light); }
        .dark-mode .no-history-msg { color: var(--text-secondary-dark); }

        /* --- 10. 響應式設計 (Responsive Design) --- */
        @media (max-width: 768px) {
            .main-content-wrapper { width: 90%; }
            .page-container { padding: 1rem 0; }
            .settings-card, .reader-card { padding: 1.5rem; box-shadow: none; }
            body.fullscreen-mode .reader-card { padding: 1.5rem; } /* Keep mobile padding smaller */
            .settings-header { margin-bottom: 2rem; flex-direction: column; align-items: center; gap: 0.75rem; }
            .settings-header .title-group h1 { font-size: 1.8rem; }
            .settings-header .header-controls { position: static; }
            .reader-controls .left-controls, .reader-controls .right-controls { gap: 0.2rem; }
            .page-content { padding: 2rem 1.5rem; line-height: 1.9; overflow-y: auto; }
            #sizer { padding: 2rem 1.5rem; }
            .page-content h2.article-title { font-size: calc(var(--reader-font-size) + 0.4rem); }
            .history-controls { flex-direction: column; }
            .illustration-container { width: 100%; }
        }

        /* --- 11. 版權聲明 (Copyright) --- */
        .copyright-footer {
            position: fixed;
            bottom: 0;
            right: 0;
            padding: 5px 10px;
            background-color: var(--bg-color-light);
            z-index: 500;
            transition: background-color 0.4s, color 0.4s;
        }

        .dark-mode .copyright-footer {
            background-color: var(--bg-color-dark);
        }

        .copyright-footer p {
            margin: 0;
            font-size: 14px;
            color: var(--text-secondary-light);
        }

        .dark-mode .copyright-footer p {
             color: var(--text-secondary-dark);
        }

        @media (max-width: 600px) {
            .copyright-footer p {
                font-size: 12px;
            }
        }
    </style>
</head>
<body class="light-mode">

    <!-- Main Content -->
    <div class="page-container">
        <div class="main-content-wrapper">
            <!-- 設定卡片 (初始顯示) -->
            <section class="settings-card" id="settings-section">
                <header class="settings-header">
                    <div class="title-group">
                        <h1>小說散文・節錄</h1>
                        <p>與文學巨擘對話，探索思想的深度</p>
                    </div>
                    <div class="header-controls">
                        <button class="icon-btn" id="history-btn" title="閱覽紀錄">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20v2H6.5A2.5 2.5 0 0 1 4 19.5z"></path><path d="M4 5h16v12H6.5A2.5 2.5 0 0 1 4 14.5V5z"></path></svg>
                        </button>
                        <button class="icon-btn theme-switcher-btn" id="settings-theme-switcher" title="切換主題">
                           <svg class="icon-theme-light" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                           <svg class="icon-theme-dark hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                        </button>
                    </div>
                </header>
                <form id="prose-form">
                    <div class="form-group">
                        <label for="difficulty">難度<span class="required-indicator">*</span></label>
                        <div class="rating-dots" id="difficulty-rating" data-rating="0">
                            <div class="rating-dot" data-value="1"></div><div class="rating-dot" data-value="2"></div>
                            <div class="rating-dot" data-value="3"></div><div class="rating-dot" data-value="4"></div>
                            <div class="rating-dot" data-value="5"></div>
                        </div>
                        <div id="error-message">請選擇難度</div>
                    </div>
                    <!-- NEW: Model Selector -->
                    <div class="form-group">
                        <label for="model-select">模型</label>
                       <select id="model-select" name="model">
                         <option value="Qwen3-235B-A22B-Instruct-2507-FP8" selected>水心</option>
                          <option value="DeepSeek-R1-0528" >魚木</option> 
                          
</select>
                    </div>
                    <div class="form-group">
                        <label for="prompt">主題</label>
                        <textarea id="prompt" placeholder="可輸入作品主題..."></textarea>
                    </div>
                    <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-bottom: 1.5rem;">
                        <input type="checkbox" id="generate-illustrations-checkbox" style="width: 18px; height: 18px; cursor: pointer;">
                        <label for="generate-illustrations-checkbox" style="margin-bottom: 0; cursor: pointer; font-weight: normal;">插圖</label>
                    </div>
                    <button type="submit" id="generate-btn" class="submit-btn">
                        <span class="btn-text">尋找節錄</span>
                    </button>
                </form>
            </section>
            
            <!-- 閱讀器卡片 (初始隱藏) -->
            <section class="reader-card hidden" id="reading-section">
                <div class="reader-controls">
                     <div class="left-controls">
                        <button class="icon-btn" id="back-to-settings-btn" title="返回設定">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                        </button>
                    </div>
                    <div id="reader-pagination" class="reader-pagination"></div>
                    <div class="right-controls">
                         <div class="font-controls">
                            <button class="icon-btn" id="font-size-decrease-btn" title="縮小字體">
                               <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14h6m-6 0v-2a2 2 0 0 1 2-2h2"/><path d="M4 7V6a2 2 0 0 1 2-2h2"/><path d="M10 7V6a2 2 0 0 1 2-2h1"/><text x="14" y="15" font-size="10" font-family="sans-serif" text-anchor="middle">A</text><text x="19" y="15" font-size="6" font-family="sans-serif" text-anchor="middle">A</text></svg>
                            </button>
                             <button class="icon-btn" id="font-size-increase-btn" title="放大字體">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14h6m-6 0v-2a2 2 0 0 1 2-2h2"/><path d="M4 7V6a2 2 0 0 1 2-2h2"/><path d="M10 7V6a2 2 0 0 1 2-2h1"/><text x="15" y="15" font-size="12" font-family="sans-serif" text-anchor="middle">A</text><text x="21" y="15" font-size="8" font-family="sans-serif" text-anchor="middle">A</text></svg>
                            </button>
                         </div>
                         <button class="icon-btn theme-switcher-btn" id="reader-theme-switcher" title="切換主題">
                           <svg class="icon-theme-light" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                           <svg class="icon-theme-dark hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                        </button>
                        <button class="icon-btn fullscreen-btn" id="fullscreen-btn" title="全螢幕模式">
                            <svg class="icon-enter-fullscreen" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
                            <svg class="icon-exit-fullscreen" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 0-2-2h-3m-12 0H5a2 2 0 0 0-2 2v3"></path></svg>
                        </button>
                    </div>
                </div>
                <div class="book-container" id="book-container">
                    <div class="book" id="book"></div>
                </div>
                <div id="sizer"></div>
            </section>
        </div>
    </div>

    <!-- 歷史紀錄彈出層 (Modal) -->
    <div class="history-modal" id="history-modal">
        <div class="history-container">
            <div class="history-header">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <h2>閱覽紀錄</h2>
                    <button class="icon-btn" id="delete-all-history-btn" title="刪除全部紀錄">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                </div>
                <button class="icon-btn" id="history-close-btn" title="關閉">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="history-controls">
                <input type="search" id="history-search" placeholder="搜尋標題...">
                <select id="history-sort">
                    <option value="date_desc">按生成日期 (新到舊)</option>
                    <option value="date_asc">按生成日期 (舊到新)</option>
                    <option value="stroke_asc">按文章標題筆劃 (少到多)</option>
                    <option value="stroke_desc">按文章標題筆劃 (多到少)</option>
                </select>
            </div>
            <ul class="history-list" id="history-list"></ul>
        </div>
    </div>
    
    <footer class="copyright-footer">
        <p>Copyright © 2025 陳冠健. All rights reserved.</p>
    </footer>

    <script>
    // --- Main application logic ---
    function initializeApp() {
        // --- 1. DOM 元素選擇 ---
        const body = document.body;
        const root = document.documentElement;
        const settingsSection = document.getElementById('settings-section');
        const readingSection = document.getElementById('reading-section');
        const themeSwitchers = document.querySelectorAll('.theme-switcher-btn');
        const proseForm = document.getElementById('prose-form');
        const difficultyRating = document.getElementById('difficulty-rating');
        const ratingDots = difficultyRating.querySelectorAll('.rating-dot');
        const errorMessage = document.getElementById('error-message');
        const modelSelect = document.getElementById('model-select'); // NEW: Select model dropdown
        const promptTextarea = document.getElementById('prompt');
        const generateBtn = document.getElementById('generate-btn');
        const generateBtnText = generateBtn.querySelector('.btn-text');
        const book = document.getElementById('book');
        const bookContainer = document.getElementById('book-container');
        const sizer = document.getElementById('sizer');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const backToSettingsBtn = document.getElementById('back-to-settings-btn');
        const historyBtn = document.getElementById('history-btn');
        const historyModal = document.getElementById('history-modal');
        const historyCloseBtn = document.getElementById('history-close-btn');
        const historyList = document.getElementById('history-list');
        const historySearch = document.getElementById('history-search');
        const historySort = document.getElementById('history-sort');
        const deleteAllHistoryBtn = document.getElementById('delete-all-history-btn');
        const fontSizeIncreaseBtn = document.getElementById('font-size-increase-btn');
        const fontSizeDecreaseBtn = document.getElementById('font-size-decrease-btn');
        const generateIllustrationsCheckbox = document.getElementById('generate-illustrations-checkbox');
        const readerPagination = document.getElementById('reader-pagination');

        // --- API 配置信息 ---
        const API_KEYS = ["sk-GruTbLTbtSeWof3rEBjtIg"];
        let currentApiKeyIndex = 0;
        const API_URL = "https://chatapi.akash.network/api/v1/chat/completions";
        
        // --- 2. 狀態管理 ---
        let state = {
            difficulty: 0,
            history: JSON.parse(localStorage.getItem('proseHistory_v3')) || [],
            currentArticle: null,
            currentPageNum: 0,
            totalPages: 0,
            fontSize: 1.1,
        };
        let isDragging = false, dragStartX = 0, currentTranslate = 0, startTranslate = 0;

        // --- 3. 初始化 ---
        const initTheme = () => {
            const savedTheme = localStorage.getItem('theme') || 'light-mode';
            if (savedTheme === 'dark-mode') {
                body.classList.remove('light-mode');
                body.classList.add('dark-mode');
            } else {
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
            }
            updateThemeIcons(savedTheme);
        };

        const initFontSize = () => {
            state.fontSize = parseFloat(localStorage.getItem('fontSize')) || 1.1;
            root.style.setProperty('--reader-font-size', `${state.fontSize}rem`);
        };

        initTheme();
        initFontSize();
        
        // --- 4. 事件監聽器 ---
        themeSwitchers.forEach(switcher => {
            switcher.addEventListener('click', () => {
                const isCurrentlyLight = body.classList.contains('light-mode');
                const currentTheme = isCurrentlyLight ? 'light-mode' : 'dark-mode';
                const newTheme = isCurrentlyLight ? 'dark-mode' : 'light-mode';
                
                body.classList.remove(currentTheme);
                body.classList.add(newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcons(newTheme);

                const inReaderView = !readingSection.classList.contains('hidden');
                if (inReaderView) {
                    if (!body.classList.contains('fullscreen-mode')) {
                        body.classList.add('fullscreen-mode');
                    }
                    if (state.currentArticle) {
                       setTimeout(() => displayArticleAsBook(state.currentArticle), 50);
                    }
                }
            });
        });

        ratingDots.forEach(dot => {
            dot.addEventListener('click', () => {
                state.difficulty = parseInt(dot.dataset.value);
                difficultyRating.dataset.rating = state.difficulty;
                errorMessage.style.display = 'none';
                updateRatingDots();
            });
            dot.addEventListener('mouseover', () => {
                const hoverValue = parseInt(dot.dataset.value);
                ratingDots.forEach(d => d.classList.toggle('selected', d.dataset.value <= hoverValue));
            });
        });
        difficultyRating.addEventListener('mouseout', updateRatingDots);

        proseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (state.difficulty === 0) {
                errorMessage.style.display = 'block';
                return;
            }

            setLoading(true, '尋找文章中...');
            try {
                const article = await generateProse();
                if (!article) return; 

                if (generateIllustrationsCheckbox.checked) {
                    setLoading(true, '生成插圖中...');
                    article.illustrationData = await prepareIllustrations(article.content);
                }

                article.generatedDate = new Date().toISOString();
                state.currentArticle = article;
                addToHistory(state.currentArticle);
                
                state.currentPageNum = 0; 
                
                body.classList.add('fullscreen-mode');
                displayArticleAsBook(state.currentArticle);
                switchToReaderView();

            } catch (error) {
                console.error('生成流程錯誤:', error);
                alert(`處理失敗: ${error.message}`);
            } finally {
                setLoading(false);
            }
        });

        fullscreenBtn.addEventListener('click', toggleFullscreen);
        backToSettingsBtn.addEventListener('click', () => {
            if (body.classList.contains('fullscreen-mode')) toggleFullscreen();
            switchToSettingsView();
        });

        fontSizeIncreaseBtn.addEventListener('click', () => changeFontSize(0.1));
        fontSizeDecreaseBtn.addEventListener('click', () => changeFontSize(-0.1));

        historyBtn.addEventListener('click', showHistory);
        historyCloseBtn.addEventListener('click', hideHistory);
        deleteAllHistoryBtn.addEventListener('click', deleteAllHistory);
        historyModal.addEventListener('click', (e) => { if (e.target === historyModal) hideHistory(); });
        historyList.addEventListener('click', handleHistoryListClick);
        historySearch.addEventListener('input', renderHistory);
        historySort.addEventListener('change', renderHistory);
        
        bookContainer.addEventListener('mousedown', dragStart);
        bookContainer.addEventListener('touchstart', dragStart, { passive: true });
        document.addEventListener('mousemove', dragMove);
        document.addEventListener('touchmove', dragMove, { passive: true });
        document.addEventListener('mouseup', dragEnd);
        document.addEventListener('touchend', dragEnd);
        book.addEventListener('click', handleIllustrationClick);

        // --- 5. 核心功能函式 ---
        function updateThemeIcons(theme) {
            themeSwitchers.forEach(switcher => {
                const lightIcon = switcher.querySelector('.icon-theme-light');
                const darkIcon = switcher.querySelector('.icon-theme-dark');
                lightIcon.classList.toggle('hidden', theme === 'dark-mode');
                darkIcon.classList.toggle('hidden', theme === 'light-mode');
            });
        }

        function updateRatingDots() {
            ratingDots.forEach(dot => {
                dot.classList.toggle('selected', dot.dataset.value <= state.difficulty);
            });
        }
        
        function setLoading(isLoading, text = '尋找經典') {
            generateBtn.disabled = isLoading;
            generateBtnText.textContent = text;
            
            const existingLoader = generateBtn.querySelector('.loader');
            if (isLoading) {
                if (!existingLoader) {
                    const loader = document.createElement('div');
                    loader.className = 'loader';
                    generateBtn.insertBefore(loader, generateBtnText);
                }
            } else {
                if (existingLoader) existingLoader.remove();
                generateBtnText.textContent = '尋找經典';
            }
        }

        function switchToReaderView() {
            settingsSection.classList.add('hidden');
            readingSection.classList.remove('hidden');
        }

        function switchToSettingsView() {
            readingSection.classList.add('hidden');
            settingsSection.classList.remove('hidden');
            state.currentArticle = null;
            state.totalPages = 0;
            updatePaginationDisplay();
        }

        function toggleFullscreen() { 
            body.classList.toggle('fullscreen-mode');
            if (state.currentArticle) {
                setTimeout(() => displayArticleAsBook(state.currentArticle), 50);
            }
        }
        
        function updatePaginationDisplay() {
            if (readerPagination) {
                if (state.totalPages > 0) {
                    readerPagination.textContent = `${state.currentPageNum + 1} / ${state.totalPages}`;
                } else {
                    readerPagination.textContent = '';
                }
            }
        }

        async function generateProse() {
            const userPrompt = promptTextarea.value.trim();
            const selectedModel = modelSelect.value; // NEW: Get selected model
            const systemPrompt = `你是一位精通世界文學的圖書館員。你的任務是根據用戶要求，從浩瀚的白話文學作品中，找出一篇真實繁體中文文章或小說節錄段落。
用戶的文學鑑賞難度偏好（1星最淺白，5星最艱深）：${state.difficulty}顆星。
${userPrompt ? `用戶的個性化要求： "${userPrompt}"` : `請隨機推薦一篇符合上述難度的文章或小說節錄。`}

為了確保每次都能生成全新的內容，請將此唯一請求 ID 納入考量：${Date.now()}。

重要指示：
1. 你必須找出現實世界中，由真實作家所寫的文章或小說作品節錄段落。禁止虛構內容。
2. 你必須提供此散文或小說的節錄段落，適合一次閱讀完。
3. 你的回傳內容必須嚴格遵循以下 JSON 格式，不要包含任何 markdown 語法或額外說明。
4. 所有文字都必須是繁體中文。
5. [作品賞析] 必須針對你推薦的這篇真實作品節錄段落進行分析，可包含作者背景、寫作風格、或該作品的歷史意義。

JSON 格式如下：
{
  "title": "{這裡填寫真實的作品標題，注明【節錄】}",
  "author": "{這裡強制以「小說散文・節錄」替代真實的作家姓名}",
  "outline": "{這裡填寫一段約 50 字的真實作品綱要或引言，這裡強制以「作者」二字替代真實的作家姓名}",
  "content": "{這裡貼上完整的真實文章或小說節錄段落，段落之間用 \\n 分隔}",
  "appreciation": {
    "title": "作品賞析",
    "text": "{這裡填寫對這篇真實作品節錄段落的賞析內容，這裡強制以「作者」二字替代真實的作家姓名，請隱真真實的作家姓名}"
  }
}`;
            
            const currentKey = API_KEYS[currentApiKeyIndex];
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentKey}` },
                    body: JSON.stringify({
                        model: selectedModel, // UPDATED: Use selected model
                        messages: [{ role: "user", content: systemPrompt }],
                        response_format: { type: "json_object" },
                        max_tokens: 64000,
                        temperature: 1.0
                    })
                });

                if (!response.ok) throw new Error(`API 請求失敗，狀態碼：${response.status}`);
                const data = await response.json();
                if (!data.choices?.[0]?.message?.content) throw new Error("API 回應格式不正確。");
                const article = JSON.parse(data.choices[0].message.content);
                if (!article.title || !article.author || !article.content) throw new Error("API 回應的 JSON 內容不完整。");
                return article;
            } catch(error) {
                console.error("API Error:", error);
                if (error instanceof SyntaxError) alert("API 回傳格式錯誤，無法解析文章。請稍後再試。");
                else alert(`獲取文章時發生錯誤: ${error.message}`);
                return null;
            }
        }

        function addToHistory(article) {
            state.history = state.history.filter(item => item.title !== article.title);
            state.history.unshift(article);
            if (state.history.length > 50) state.history.pop();
            localStorage.setItem('proseHistory_v3', JSON.stringify(state.history));
        }
        
        // --- 6. 書本、分頁與插圖邏輯 ---
        function changeFontSize(amount) {
            const newSize = Math.max(0.8, Math.min(1.8, state.fontSize + amount));
            state.fontSize = Math.round(newSize * 10) / 10;
            localStorage.setItem('fontSize', state.fontSize);
            root.style.setProperty('--reader-font-size', `${state.fontSize}rem`);
            if (state.currentArticle) {
                displayArticleAsBook(state.currentArticle);
            }
        }
        
        function paginateArticle(article) {
            const containerWidth = bookContainer.clientWidth;
            const containerHeight = bookContainer.clientHeight;
            if (containerWidth === 0 || containerHeight === 0) {
                console.error("Book container has no size. Cannot paginate.");
                return ["錯誤：無法計算頁面尺寸。"];
            }

            sizer.style.width = containerWidth + 'px';
            sizer.style.height = containerHeight + 'px';
            
            const firstPageHeader = `<h2 class="article-title">${article.title}</h2><p class="article-author">文 / ${article.author}</p><div class="article-outline">${article.outline}</div>`;
            
            let fullContentHTML;
            const textToParagraphs = (text) => {
                if (!text) return "";
                return text.split('\n').filter(p => p.trim() !== '').map(p => `<p>${p}</p>`).join('');
            };

            if (article.illustrationData && article.illustrationData.length > 0) {
                let processedHTML = '';
                const illustrationChunks = chunkTextForIllustrations(article.content);

                for (let i = 0; i < illustrationChunks.length; i++) {
                    const chunk = illustrationChunks[i];
                    processedHTML += chunk.paragraphs.map(p => `<p>${p}</p>`).join('');
                    const illustrationResult = article.illustrationData[i];
                    
                    if (illustrationResult) {
                       const textPromptAttr = `data-text-prompt="${encodeURIComponent(chunk.textForPrompt)}"`;
                       const indexAttr = `data-illustration-index="${i}"`;
                       if (illustrationResult.status === 'fulfilled' && illustrationResult.value) {
                           processedHTML += `<div class="illustration-container" ${textPromptAttr} ${indexAttr}><img src="${illustrationResult.value}" alt="文章插圖"></div>`;
                       } else if (illustrationResult.status === 'rejected') {
                           const errorMessage = illustrationResult.reason?.message?.includes('翻譯') ? '翻譯失敗，無法生成。' : '圖片生成失敗。';
                           processedHTML += `<div class="illustration-container" ${textPromptAttr} ${indexAttr}><div class="illustration-error" title="點擊以重試"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg><p>${errorMessage}<br>點擊此處重試。</p></div></div>`;
                       }
                    }
                }
                fullContentHTML = processedHTML;
            } else {
                fullContentHTML = textToParagraphs(article.content);
            }

            const appreciationHTML = textToParagraphs(article.appreciation.text);
            fullContentHTML += `<div class="article-appreciation"><h3>${article.appreciation.title}</h3>${appreciationHTML}</div>`;
            
            const contentDoc = new DOMParser().parseFromString(`<div>${fullContentHTML}</div>`, 'text/html');
            const contentNodes = Array.from(contentDoc.body.firstChild.childNodes);
            
            let pages = [];
            let currentPageHTML = firstPageHeader;
            sizer.innerHTML = currentPageHTML;

            for (const node of contentNodes) {
                if (node.nodeType === 1 && node.classList.contains('illustration-container')) {
                    if (currentPageHTML.trim() && currentPageHTML !== firstPageHeader) {
                        pages.push(currentPageHTML);
                    }
                    pages.push(node.outerHTML);
                    currentPageHTML = '';
                    sizer.innerHTML = '';
                    continue;
                }

                const nodeHTML = node.outerHTML || node.textContent;
                const potentialHTML = currentPageHTML + nodeHTML;
                sizer.innerHTML = potentialHTML;
                
                if (sizer.scrollHeight > containerHeight) {
                    if (currentPageHTML) { 
                        pages.push(currentPageHTML);
                    }
                    currentPageHTML = nodeHTML;
                    sizer.innerHTML = currentPageHTML;
                } else {
                    currentPageHTML = potentialHTML;
                }
            }

            if (currentPageHTML.trim()) {
                pages.push(currentPageHTML);
            }
            if (pages.length === 0) {
                pages.push(firstPageHeader);
            }

            return pages;
        }

        function displayArticleAsBook(article) {
            const currentPageBeforeRepagination = state.currentPageNum;
            book.innerHTML = '';
            book.style.transition = 'none';

            setTimeout(() => {
                if (!bookContainer.clientWidth) {
                    console.error("Pagination failed: book container not visible or has zero width.");
                    return;
                }
                const pagesContent = paginateArticle(article);
                state.totalPages = pagesContent.length;

                pagesContent.forEach((content, i) => {
                    const pageElement = document.createElement('div');
                    pageElement.className = 'page';
                    
                    const isIllustrationPage = content.includes('class="illustration-container"');
                    const contentClass = isIllustrationPage ? 'page-content page-content--illustration' : 'page-content';
                    
                    pageElement.innerHTML = `<div class="${contentClass}">${content}</div>`;
                    book.appendChild(pageElement);
                });
                
                const newPage = Math.min(currentPageBeforeRepagination, state.totalPages - 1);
                goToPage(newPage, true);

            }, 50);
        }

        function goToPage(pageNum, immediate = false) {
            const pageIndex = Math.max(0, Math.min(pageNum, state.totalPages - 1));
            state.currentPageNum = pageIndex;
            currentTranslate = -pageIndex * bookContainer.clientWidth;
            book.style.transition = immediate ? 'none' : 'transform 0.4s ease-out';
            book.style.transform = `translateX(${currentTranslate}px)`;
            updatePaginationDisplay();
        }

        function chunkTextForIllustrations(content) {
            const CHARS_PER_IMAGE = 400;
            let paragraphs = content.split('\n').filter(p => p.trim() !== '');
            let chunks = [];
            let charCountSinceLastImage = 0;
            let textBufferForPrompt = '';
            let paragraphBuffer = [];

            for (const para of paragraphs) {
                paragraphBuffer.push(para);
                textBufferForPrompt += para + " ";
                charCountSinceLastImage += para.length;

                if (charCountSinceLastImage >= CHARS_PER_IMAGE) {
                    chunks.push({ paragraphs: [...paragraphBuffer], textForPrompt: textBufferForPrompt.trim() });
                    charCountSinceLastImage = 0;
                    textBufferForPrompt = '';
                    paragraphBuffer = [];
                }
            }
            if (paragraphBuffer.length > 0) {
                 chunks.push({ paragraphs: [...paragraphBuffer], textForPrompt: textBufferForPrompt.trim() });
            }
            return chunks;
        }

        async function prepareIllustrations(content) {
            const chunks = chunkTextForIllustrations(content);
            const baseSeed = Math.floor(Math.random() * 1000000);
            const illustrationPromises = chunks.map((chunk, i) => {
                return generateSingleImageURL(chunk.textForPrompt, baseSeed + i);
            });
            return await Promise.allSettled(illustrationPromises);
        }
        
        async function generateSingleImageURL(textPrompt, seed) {
            const englishPara = await translateToEnglish(textPrompt);
            if (!englishPara) throw new Error('翻譯失敗');
            const prompt = generateImagePrompt(englishPara);
            const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?token=Jeq-UCxbpvrqUEzN&model=flux&enhance=false&private=true&nologo=true&seed=${seed}`;
            const response = await fetch(imageUrl);
            if (!response.ok) {
                 throw new Error('圖片生成失敗 (fetch failed)');
            }
            return imageUrl;
        }

        async function handleIllustrationClick(e) {
            const container = e.target.closest('.illustration-container');
            if (!container) return;
            const illustrationIndexStr = container.dataset.illustrationIndex;
            if (illustrationIndexStr === undefined) return;
            const illustrationIndex = parseInt(illustrationIndexStr);
            if (confirm('您確定要重新生成這張插圖嗎？')) {
                const textPrompt = decodeURIComponent(container.dataset.textPrompt);
                const newSeed = Math.floor(Math.random() * 10000000);
                container.innerHTML = `<div class="illustration-loader"><div class="spinner"></div><p>重新生成中...</p></div>`;
                try {
                    const imageUrl = await generateSingleImageURL(textPrompt, newSeed);
                    const img = new Image();
                    img.onload = () => {
                        container.innerHTML = '';
                        img.alt = '文章插圖';
                        container.appendChild(img);
                        updateIllustrationInHistory(illustrationIndex, imageUrl);
                    };
                    img.onerror = () => { throw new Error('圖片載入失敗'); };
                    img.src = imageUrl;
                } catch (error) {
                    const errorMessage = error.message.includes('翻譯') ? '翻譯失敗，無法生成。' : '圖片生成失敗。';
                    container.innerHTML = `<div class="illustration-error" title="點擊以重試"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg><p>${errorMessage}<br>點擊此處重試。</p></div>`;
                }
            }
        }
        
        function updateIllustrationInHistory(index, newImageUrl) {
            if (!state.currentArticle || !state.currentArticle.illustrationData) return;
            state.currentArticle.illustrationData[index] = { status: 'fulfilled', value: newImageUrl, reason: undefined };
            const historyIndex = state.history.findIndex(item => item.title === state.currentArticle.title && item.author === state.currentArticle.author);
            if (historyIndex !== -1) {
                state.history[historyIndex].illustrationData = state.currentArticle.illustrationData;
                localStorage.setItem('proseHistory_v3', JSON.stringify(state.history));
                console.log(`歷史紀錄已更新：文章 "${state.currentArticle.title}" 的第 ${index + 1} 張插圖已更新。`);
            } else {
                console.warn("在歷史紀錄中找不到當前文章，無法更新插圖。");
            }
        }

        // --- 7. 翻頁互動處理 ---
        function dragStart(e) { isDragging = true; dragStartX = e.touches ? e.touches[0].clientX : e.clientX; startTranslate = currentTranslate; book.style.transition = 'none'; }
        function dragMove(e) { if (!isDragging) return; const currentX = e.touches ? e.touches[0].clientX : e.clientX; const diff = currentX - dragStartX; currentTranslate = startTranslate + diff; book.style.transform = `translateX(${currentTranslate}px)`; }
        function dragEnd() { if (!isDragging) return; isDragging = false; const threshold = bookContainer.clientWidth / 5; const endTranslate = -state.currentPageNum * bookContainer.clientWidth; const movedBy = currentTranslate - endTranslate; if (movedBy < -threshold && state.currentPageNum < state.totalPages - 1) { goToPage(state.currentPageNum + 1); } else if (movedBy > threshold && state.currentPageNum > 0) { goToPage(state.currentPageNum - 1); } else { goToPage(state.currentPageNum); } }

        // --- 8. 歷史紀錄相關函式 ---
        function showHistory() { renderHistory(); historyModal.classList.add('is-visible'); }
        function hideHistory() { historyModal.classList.remove('is-visible'); }
        
        function deleteAllHistory() {
            if (state.history.length === 0) return;
            if (confirm('您確定要刪除所有閱覽紀錄嗎？此操作無法復原。')) {
                state.history = [];
                localStorage.setItem('proseHistory_v3', JSON.stringify(state.history));
                renderHistory();
            }
        }

        function renderHistory() {
            let items = [...state.history];
            const term = historySearch.value.toLowerCase();
            if (term) items = items.filter(i => i.title.toLowerCase().includes(term));
            
            const collator = new Intl.Collator('zh-Hant', { sensitivity: 'base', collation: 'stroke' });
            items.sort((a, b) => {
                switch (historySort.value) {
                    case 'date_asc': return new Date(a.generatedDate) - new Date(b.generatedDate);
                    case 'stroke_asc': return collator.compare(a.title, b.title);
                    case 'stroke_desc': return collator.compare(b.title, a.title);
                    default: return new Date(b.generatedDate) - new Date(a.generatedDate);
                }
            });

            historyList.innerHTML = items.length === 0 
                ? `<li class="no-history-msg">${term ? '找不到符合條件的紀錄。' : '目前沒有閱覽紀錄。'}</li>`
                : items.map(item => `<li data-history-title="${encodeURIComponent(item.title)}">
                                        <div class="history-item-content">
                                            <div class="history-list-item-title">${item.title}</div>
                                            <div class="history-list-item-meta">${new Date(item.generatedDate).toLocaleDateString('zh-TW')}</div>
                                        </div>
                                        <button class="icon-btn delete-history-btn" title="刪除此紀錄">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                        </button>
                                     </li>`).join('');
        }
        
        function handleHistoryListClick(e) {
            const deleteBtn = e.target.closest('.delete-history-btn');
            if (deleteBtn) {
                const li = deleteBtn.closest('li[data-history-title]');
                if (li) {
                    const titleToDelete = decodeURIComponent(li.dataset.historyTitle);
                    if (confirm(`您確定要刪除「${titleToDelete}」這篇閱覽紀錄嗎？`)) {
                        state.history = state.history.filter(item => item.title !== titleToDelete);
                        localStorage.setItem('proseHistory_v3', JSON.stringify(state.history));
                        renderHistory();
                    }
                }
                return;
            }

            const content = e.target.closest('.history-item-content');
            if (content) {
                const li = content.closest('li[data-history-title]');
                const articleTitle = decodeURIComponent(li.dataset.historyTitle);
                const article = state.history.find(item => item.title === articleTitle);
                if (article) {
                    state.currentArticle = article;
                    state.currentPageNum = 0;
                    body.classList.add('fullscreen-mode');
                    displayArticleAsBook(article);
                    switchToReaderView();
                    hideHistory();
                }
            }
        }

        // --- 9. 插圖生成輔助函式 ---
        async function translateToEnglish(textToTranslate) {
            const myEmail = 'kenchan20151@gmail.com'; 
            const apiUrl = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(textToTranslate)}&langpair=zh-TW|en&de=${myEmail}`;
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`翻譯API失敗，狀態碼 ${response.status}`);
                const data = await response.json();
                if (data.responseStatus !== 200) throw new Error(`翻譯API錯誤: ${data.responseDetails}`);
                return data.responseData?.translatedText || null;
            } catch (error) {
                console.error('翻譯錯誤:', error);
                return null;
            }
        }
        
        function generateImagePrompt(englishParagraph) {
            return `Illustration of: "${englishParagraph}". Rendered in a classic manga style with an emphasis on simplicity. Use only black and white, with clean, uniform, and minimalist line art. The overall feel should be a high-contrast, clear monochrome comic panel or sketch. No text is included.`;
        }
    }

    // --- Initialize app on page load ---
    document.addEventListener('DOMContentLoaded', () => {
        initializeApp();
    });
    </script>
</body>
</html>
